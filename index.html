<!DOCTYPE html>
<meta charset="utf-8">
<style>

img {opacity:.66}

</style>
<script>

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4871207-9', 'benschmidt.org');
  ga('send', 'pageview');

</script>

<link rel="stylesheet" href="thumbnails.css" type="text/css"/>
<body>
<h1>Coverspace: an in-browser tool for dynamically visualizing images</h1>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="d3-grid/d3-grid.js"></script>

<body>

X axis: <select id="x" class="axisSelector">
</select>
<br>
Y axis: <select id="y" class="axisSelector"></select>

<div id=displaySpace></div>
<script>

var data;
height = window.innerHeight
width = window.innerWidth
x = d3.scale.linear().domain([0,1]).range([0,window.innerWidth])
y = d3.scale.linear().domain([0,1]).range([0,window.innerHeight-200])


var overall,bounds;

updateScale = function(myScale,myValues) {
    //updates a scale to work with a new set of output values:
    //dynamically changes depending on if it's a numeric range or a sortable set of strings (treated as a factor scale)
    myRange = d3.extent(myScale.range())
    tmp = myValues
    extent = d3.extent(tmp.map(parseFloat))
    if (isNaN(parseFloat(extent[0]))) {
	sorted = tmp.sort()
	myScale = d3.scale.ordinal().domain(sorted).rangePoints(myRange)
    } else {
	myScale = d3.scale.linear().domain(extent).range(myRange)
    }			
    return myScale
}


updateOptions = function(keys) {
    //options are dynamically updated according to the keys you put in.
    var options = keys.sort()
    optionMenus = d3.selectAll(".axisSelector").selectAll("option").data(options)
    optionMenus.enter().append("option").attr("value",function(d) {return(d)}).text(function(d) {return (d)})
}

checkVariable = function(element) {
    //Code stolen from somewhere.
    dropdown = d3.select(element)
    var value = dropdown.node().options[dropdown.node().selectedIndex].value;
    return(value)
    dropdown.on("change",update)
}

d3.json("summaries.json",function(images) {
    data = images
    data = data.filter(function(d) {return d3.keys(d).length>0})
    data = data.map(function(d) {
	dated = Date.parse(d.id.split(".")[0])
	if(isNaN(dated)) {return d}
	dated = new Date(dated)
	d.year = new Date(dated).getFullYear()
	d.decade = 10*Math.floor(d.year/10)
	d.remainder = d.year%10
	d.month = dated.getMonth()
	return d;
    })
    //Some blank objects are creeping in: this isn't the best place to fix it, but hey. 
    updateOptions(d3.keys(data[0]))
    update()
})

update = function() {
    selection = d3
	.select("#displaySpace")
	.selectAll(".image.container")
	.data(data,function(d) {return d.filename})

    yVariable = checkVariable("#y")
    xVariable = checkVariable("#x")
    y = updateScale(y,data.map(function(d) {return d[yVariable]}))
    x = updateScale(x,data.map(function(d) {return d[xVariable]}))
    

    if (yVariable===xVariable & true) {
	sculpted = d3.nest().key(function(d) {return(d[xVariable])}).entries(data)

        sculpted.sort(function(a,b) {return a.key > b.key})

        console.log("arraying on a grid of size " + sculpted.length)
	sculpted = d3.layout.grid()
	    .bands()
	    .size([width,height])(sculpted);
							      sculpted.map(function(d) {d.values.map(function(e) {e.x=d.x; e.y=d.y})})
							      console.log(sculpted[0])
	data = sculpted.map(function(d) {return d.values}).reduce(function(a,b) {return a.concat(b)})
    } else {
	data=data.map(function(d) {
	    d.x = x(d[xVariable])	
	    d.y = y(d[yVariable])		   
	    return d
	})
    }

    selection
	.enter()
        .append("a")
	.attr("href",function(d) {return d.filename})
        .attr("target","_blank")
	.style("top",function(d) {val =  y(d[yVariable]); return((200 + d.y) + "px")})
	.style("left",function (d) {return d.x+"px";return x(d[xVariable]) +"px"})
	.attr("class","image container")
	.append("div")
        .attr("class",function(d) {return "sprite-thumbnails-" + d.id.split(".")[0]})
        .attr("id",function(d) {return(d.filename)})
	.style("position","absolute")
        .style("opacity","")
	.on("mouseover",function(d) {d3.select(this).style("opacity",1)})
	.on("mouseout",function(d) {d3.select(this).style("opacity",.75)})
	.attr("title",function(d) {return("filename: " + d.filename)})

    //selection.exit().transition().style("opacity",0).remove()
    selection
	.transition()
	.duration(3000)
	.style("top",function(d) {return((200+d.y)+"px");val =  y(d[checkVariable("#y")]); return(val + "px")})
	.style("left",function (d) {return(d.x + "px"); return x(d[checkVariable("#x")]) +"px"})
	.style("position","absolute")


}

d3.selectAll(".axisSelector").on("change",update)
</script>
</body>
