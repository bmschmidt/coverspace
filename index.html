<!DOCTYPE html>
<meta charset="utf-8">
<style>

img {opacity:.66}

</style>
<script>

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4871207-9', 'benschmidt.org');
  ga('send', 'pageview');

</script>


<body>
<h1>Coverspace</h1>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>

<body>

X axis: <select id="x" class="axisSelector">
</select>
<br>
Y axis: <select id="y" class="axisSelector"></select>

<div id=displaySpace></div>

<script>

var data;
height = window.innerHeight
width = window.innerWidth
x = d3.scale.linear().domain([0,1]).range([0,window.innerWidth])
y = d3.scale.linear().domain([0,1]).range([200,window.innerHeight-200])


updateOptions = function(keys) {
    //options are dynamically updated according to the keys you put in.
    var options = keys.sort()
    console.log(options)
    optionMenus = d3.selectAll(".axisSelector").selectAll("option").data(options)
    optionMenus.enter().append("option").attr("value",function(d) {return(d)}).text(function(d) {return (d)})
}

checkVariable = function(element) {
    //Code stolen from somewhere.
    dropdown = d3.select(element)
    var value = dropdown.node().options[dropdown.node().selectedIndex].value;
    return(value)
    dropdown.on("change",update)
}

d3.json("summaries.json",function(images) {
    data = images
    data = data.filter(function(d) {return d3.keys(d).length>0}) //Some blank objects are creeping in: this isn't the best place to fix it. 
    console.log(data.length)
    updateOptions(d3.keys(data[0]))
    update()
})

var tmp,extent
updateScale = function(myScale,myValues) {
    myRange = d3.extent(myScale.range())
    tmp = myValues

    extent = d3.extent(tmp.map(parseFloat))
    console.log(extent)
    if (isNaN(parseFloat(extent[0]))) {
	console.log("not parsed")
	sorted = tmp.sort()
	myScale = d3.scale.ordinal().domain(sorted).rangePoints(myRange)
    } else {
	myScale = d3.scale.linear().domain(extent).range(myRange)
    }			
    return myScale
}

update = function() {
    selection = d3
	.select("#displaySpace")
	.selectAll(".image.container")
	.data(data,function(d) {return d.filename})

    yVariable = checkVariable("#y")
    xVariable = checkVariable("#x")
    y = updateScale(y,data.map(function(d) {return d[yVariable]}))
    x = updateScale(x,data.map(function(d) {return d[xVariable]}))

    selection
	.enter()
        .append("a")
	.attr("href",function(d) {return d.filename})
	.style("top",function(d) {val =  y(d[checkVariable("#y")]); return(val + "px")})
	.style("left",function (d) {return x(d[checkVariable("#x")]) +"px"})
	.attr("class","image container")
	.append("img")
	.attr("id",function(d) {return(d.filename)})
	.attr("src",function(d) {return d.filename})
	.style("position","absolute")
        .style("opacity",.66)
	.on("mouseover",function(d) {console.log("hi"); d3.select(this).style("opacity",1)})
	.on("mouseout",function(d) {d3.select(this).style("opacity",.75)})
	.attr("title",function(d) {return("filename: " + d.filename)})

    selection
	.transition()
	.duration(3000)
	.style("top",function(d) {val =  y(d[checkVariable("#y")]); return(val + "px")})
	.style("left",function (d) {return x(d[checkVariable("#x")]) +"px"})
	.style("position","absolute")

}
d3.selectAll(".axisSelector").on("change",update)
</script>
</body>
